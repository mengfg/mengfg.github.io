---
layout: post
title: Mybatis笔记（八） Mybatis中的多表查询
date: 2020-10-18
tags: Mybatis
---

### 表之间的关系

1. 一对多：用户和订单的关系
2. 多对一：订单和用户的关系
3. 一对一：人和身份证号的关系
4. 多对多：老师和学生的关系

特例：如果拿出每一个订单他都只能属于一个用户，所以Mybatis把多对一看成一对一

### Mybatis 多表查询

本次案例主要以最为简单的用户和账户的模型来分析 Mybatis 多表关系。用户为 User 表，账户为 Account
表。一个用户（User）可以有多个账户（Account）。具体关系如下： 

![9](\images\posts\mybatis\9.png)

步骤：

1. 建立两张表，用户表和账户表，让用户表和账户表有一对多的关系需要用外键关联，外键建立在账户表
2. 建立两个实体类，用户类和账户类，实体类也要体现一对多的关系。
3. 建立两个配置文件，用户配置文件和账户配置文件
4. 实现配置，当查询用户时得到账户信息，查询账户时得到用户信息

#### 一对一查询(多对一) 

需求：查询所有账户信息，关联查询下单用户信息。
注意：因为一个账户信息只能供某个用户使用，所以从查询账户信息出发关联查询用户信息为一对一查询。如
果从用户信息出发查询用户下的账户信息则为一对多查询，因为一个用户可以有多个账户。

##### 方式一：定义专门的类（AccountUser ）作为输出类型，其中定义了sql语句查询结果集的所有字段

1. 定义账户信息的实体类Account：

   ```java
   /**
   *
   * <p>Title: Account</p>
   * <p>Description: 账户的实体类</p>
   * <p>Company: http://www.itheima.com/ </p>
   */
   public class Account implements Serializable {
       private Integer id;
       private Integer uid;
       private Double money;
       //生成set/get
   }
   ```

2. 定义 AccountUser 类 

   ```java
   //定义AccountUser类中要包含账户信息同时还要包含用户信息，可以让其继承account类
   public class AccountUser extends Account implements Serializable {
       private String username;
       private String address;
     	//生成set/get
   }
   ```

3. 定义账户的持久层 Dao 接口 

   ```java
   public interface IAccountMapper {
       /**
       * 查询所有账户，同时获取账户的所属用户名称以及它的地址信息
       * @return
       */
   	List<AccountUser> findAll();
   }
   ```

4. 定义 IAccountMapper.xml 文件中的查询配置信息 

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="com.mg.dao.IAccountMapper">
       <!-- 配置查询所有操作-->
       <select id="findAll" resultType="accountuser">
       	select a.*,u.username,u.address from account a,user u where a.uid =u.id;
       </select>
   </mapper>
   
   注意：因为上面查询的结果中包含了账户信息同时还包含了用户信息，所以我们的返回值类型 returnType
   的值设置为 AccountUser 类型，这样就可以接收账户信息和用户信息了。
   ```

##### 方式二：使用 resultMap

定义专门的 resultMap 用于映射一对一查询结果。通过面向对象的(has a)关系可以得知，我们可以在 Account 类中加入一个 User 类的对象来代表这个账户是哪个用户的。 

1. 定义账户信息Account类

   ```java
   public class Account implements Serializable {
       private Integer id;
       private Integer uid;
       private Double money;
       //加入User类的引用
   	private User user;
       //生成set/get
   }
   ```

2. 定义Dao接口

   ```java
   public interface IAccountMapper {
       /**
       * 查询所有账户，同时获取账户的所属用户名称以及它的地址信息
       * @return
       */
   	List<Account> findAll();
   }
   
   注意：第二种方式，将返回值改 为了 Account 类型。
   因为 Account 类中包含了一个 User 类的对象，它可以封装账户所对应的用户信息。
   ```

3. 定义 IAccountMapper.xml 文件中的查询配置信息 

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
   <mapper namespace="com.itheima.dao.IAccountDao">
       <!-- 建立对应关系 -->
       <!-- type的值可以写别名 -->
       <resultMap type="account" id="accountMap">
           <id column="aid" property="id"/>
           <result column="uid" property="uid"/>
           <result column="money" property="money"/>
           <!-- 它是用于指定从表方的引用实体属性的 -->
           <!--association标签  用于单个关系属性 -->
           <association property="user" javaType="user">
               <id column="id" property="id"/>
               <result column="username" property="username"/>
               <result column="sex" property="sex"/>
               <result column="birthday" property="birthday"/>
               <result column="address" property="address"/>
           </association>
       </resultMap>
       
       <!--resultMap直接引用上面定义的即可-->
       <select id="findAll" resultMap="accountMap">
           select u.*,a.id as aid,a.uid,a.money from account a,user u where a.uid =u.id;
       </select>
   </mapper>
   ```

   