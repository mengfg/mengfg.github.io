---
layout: post
title: SpringMVC笔记（二） SpringMVC参数绑定
date: 2020-11-15
tags: SpringMVC
---

## 参数绑定

作用：接受client提交的数据

### 支持的数据类型 

**基本类型参数：**包括基本类型和 String 类型

**POJO 类型参数：**包括实体类，以及关联的实体类

**数组和集合类型参数：**包括 List 结构和 Map 结构的集合（包括数组） 

### 示例

#### 使用原生的ServletAPI对象 

只需要在控制器的方法中将servletApi对象当作参数传入即可

```java
@RequestMapping(value = "/converter1",method = RequestMethod.POST)
public void converter1(HttpServletRequest request) {
    String username = request.getParameter("username");
    String age = request.getParameter("age");
    String birthDay = request.getParameter("birthDay");
    System.out.println(username + "----" + age + "----" + birthDay);
}

springmvc支持传入的Sevlet原生api一共有以下这些： 
1. HttpServletRequest 
2. HttpServletResponse 
3. HttpSession 
4. java.security.Principal 
5. Locale 
6. InputStream 
7. OutputStream 
8. Reader 
9. Writer
```



#### 基本数据类型+String

要求参数名称必须和控制器中方法的形参名称保持一致。 (严格区分大小写) 

```java
//jsp 代码：
<a href="account/findAccount?accountId=10&accountName=zhangsan">查询账户</a>

控制器代码：
@RequestMapping("/findAccount")
public String findAccount(Integer accountId,String accountName) {
    System.out.println("查询了账户。。。。 "+accountId+","+accountName);
    return "success";
}
```

#### POJO 类型作为参数 

要求表单中参数名称和 POJO 类的属性名称保持一致。并且控制器方法的参数类型是 POJO 类型。 

```jsp
jsp 代码：
<form action="account/saveAccount" method="post">
    账户名称： <input type="text" name="name" ><br/>
    账户金额： <input type="text" name="money" ><br/>
    账户省份： <input type="text" name="address.provinceName" ><br/>
    账户城市： <input type="text" name="address.cityName" ><br/>
    <input type="submit" value="保存">
</form>
```

```java
实体类代码：
//账户信息
public class Account implements Serializable {
private Integer id;
private String name;
private Float money;
private Address address;
//getters and setters
}

//地址的实体类
public class Address implements Serializable {
private String provinceName;
private String cityName;
//getters and setters
}

控制器代码：
@RequestMapping("/saveAccount")
public String saveAccount(Account account) {
    System.out.println("保存了账户。。。。 "+account);
    return "success";
}
```

#### POJO 类中包含集合类型参数 

第一种：要求集合类型的请求参数必须在 POJO 中。在表单中请求参数名称要和 POJO 中集合属性名称相同。给List 集合中的元素赋值， 使用下标。给 Map 集合中的元素赋值， 使用键值对。

第二种：接收的请求参数是 json 格式数据。需要借助一个注解实现 

```java
实体类代码：
// 用户实体类
public class User implements Serializable {
    private String username;
    private String password;
    private Integer age;
    private List<Account> accounts;
    private Map<String,Account> accountMap;
    //getters and setters
}

控制器代码：
@RequestMapping("/updateAccount")
public String updateAccount(User user) {
    System.out.println("更新了账户。。。。 "+user);
    return "success";
}
```

```jsp
jsp 代码：
<form action="account/updateAccount" method="post">
    用户名称： <input type="text" name="username" ><br/>
    用户密码： <input type="password" name="password" ><br/>
    用户年龄： <input type="text" name="age" ><br/>
    账户 1 名称： <input type="text" name="accounts[0].name" ><br/>
    账户 1 金额： <input type="text" name="accounts[0].money" ><br/>
    账户 2 名称： <input type="text" name="accounts[1].name" ><br/>
    账户 2 金额： <input type="text" name="accounts[1].money" ><br/>
    账户 3 名称： <input type="text" name="accountMap['one'].name" ><br/>
    账户 3 金额： <input type="text" name="accountMap['one'].money" ><br/>
    账户 4 名称： <input type="text" name="accountMap['two'].name" ><br/>
    账户 4 金额： <input type="text" name="accountMap['two'].money" ><br/>
    <input type="submit" value="保存">
</form>
```

#### 自定义类型转换器 

当参数通过URL或者表单传递时都会转换为字符串，前面形参为Integer时也不会报错是因为SpringMVC可以实现一些数据类型的自动转换。内置转换器全都在：org.springframework.core.convert.support 包下 ，有java.lang.Boolean -> java.lang.String : ObjectToStringConverter
java.lang.Character -> java.lang.Number : CharacterToNumberFactory
java.lang.Character -> java.lang.String : ObjectToStringConverter
java.lang.Enum -> java.lang.String : EnumToStringConverter 

……………………………………等很多。

如遇特殊类型转换要求，需要我们自己编写自定义类型转换器

```java
第一步：定义一个类，实现 Converter 接口，该接口有两个泛型。

public interface Converter<S, T> {//S:表示接受的类型， T：表示目标类型
/**
* 实现类型转换的方法
*/
@Nullable
T convert(S source);
}


//自定义类型转换器
public class StringToDateConverter implements Converter<String, Date> {

    //用于把 String 类型转成日期类型
    @Override
    public Date convert(String source) {
        DateFormat format = null;
        try {
            if(StringUtils.isEmpty(source)) {
                throw new NullPointerException("请输入要转换的日期");
            }
            format = new SimpleDateFormat("yyyy-MM-dd");
            Date date = format.parse(source);
            return date;
        } catch (Exception e) {
            throw new RuntimeException("输入日期有误");
        }
	}
}
```

```xml
第二步：在 springMVC 配置文件中配置类型转换器。
spring 配置类型转换器的机制是，将自定义的转换器注册到类型转换服务中去。

<!-- 配置类型转换器工厂 -->
<bean id="converterService"
      class="org.springframework.context.support.ConversionServiceFactoryBean">
    <!-- 要给 converters属性注入值，是个set集合-->
    <property name="converters">
        <set>
        	<!-- 配置自定义类型转换器 -->
        	<bean class="com.mg.converter.StringToDateConverter"></bean>
        </set>
	</property>
</bean>

第三步：在 annotation-driven 标签中引用配置的类型转换服务
<!-- 引用自定义类型转换器 -->
<mvc:annotation-driven conversion-service="converterService"></mvc:annotation-driven>
```

### 请求参数乱码问题 

**post 请求方式：在 web.xml 中配置一个过滤器**

```xml
<!-- 配置 springMVC 编码过滤器 -->
<filter>
    <filter-name>CharacterEncodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
    <!-- 设置过滤器中的属性值 -->
    <init-param>
        <param-name>encoding</param-name>
        <param-value>UTF-8</param-value>
    </init-param>
</filter>
<!-- 过滤所有请求 -->
<filter-mapping>
    <filter-name>CharacterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>

在 springmvc 的配置文件中可以配置，静态资源不过滤：
<!-- location 表示路径， mapping 表示文件， **表示该目录下的文件以及子目录的文件 -->
<mvc:resources location="/css/" mapping="/css/**"/>
<mvc:resources location="/images/" mapping="/images/**"/>
<mvc:resources location="/scripts/" mapping="/javascript/**"/>
```

**get 请求方式：tomacat 对 GET 和 POST 请求处理方式是不同的， GET 请求的编码问题， 要改 tomcat 的server.xml**

```xml
<Connector connectionTimeout="20000" port="8080" protocol="HTTP/1.1" redirectPort="8443"/>
改为：
<Connector connectionTimeout="20000" port="8080" protocol="HTTP/1.1" redirectPort="8443"
useBodyEncodingForURI="true"/>

如果遇到 ajax 请求仍然乱码，请把：
useBodyEncodingForURI="true"改为 URIEncoding="UTF-8"
即可
```



